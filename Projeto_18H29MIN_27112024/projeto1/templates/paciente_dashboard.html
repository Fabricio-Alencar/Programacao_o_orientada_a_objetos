<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Área do Paciente</title>
    <link rel="stylesheet" href="../static/paciente_dashboard.css">
    <script>
        let isEditing = false; // Flag para verificar se estamos em modo de edição

        // Passar o ID do usuário do Flask para o JavaScript
        const usuarioId = '{{ usuario_id }}';

        async function obterInformacoesPaciente(id) {
            try {
                const response = await fetch(`/paciente/${id}`);
                if (!response.ok) {
                    throw new Error('Paciente não encontrado');
                }
                const dados = await response.json();
                const pacienteInfoDiv = document.getElementById('paciente-info');
                
                if (isEditing) {
                    // Exibir os campos editáveis se estiver em modo de edição
                    pacienteInfoDiv.innerHTML = `
                        <label>ID: <input type="text" id="edit-id" value="${dados.id}" disabled></label><br>
                        <label>Nome: <input type="text" id="edit-nome" value="${dados.nome}"></label><br>
                        <label>E-Mail: <input type="email" id="edit-email" value="${dados.email}"></label><br>
                        <div class="telefone-container">
                            <label>DDD:<input type="text" id="edit-ddd" name="ddd" placeholder="DDD" maxlength="2" value="${dados.telefone.substring(1, 3)}" onkeypress="validarEntrada(event)"></label>
                            <label>Telefone:<input type="text" id="edit-telefone" name="telefone" placeholder="Digite o telefone" minlength="8" maxlength="10" required value="${dados.telefone.substring(4)}" onkeypress="validarEntrada(event)"></label> 
                        </div>
                        <label>Tipo de Usuário: <input type="text" id="edit-tipo_usuario" value="${dados.tipo_usuario}" disabled></label><br>
                        <button class="btn" id="save-info" onclick="salvarAlteracoes('${dados.id}')">Salvar Alterações</button>
                    `;
                } else {
                    // Exibir as informações de forma estática
                    pacienteInfoDiv.innerHTML = `
                        <p>ID: ${dados.id}</p>
                        <p>Nome: ${dados.nome}</p>
                        <p>E-Mail: ${dados.email}</p>
                        <p>Telefone: ${dados.telefone}</p>
                        <p>Tipo de Usuário: ${dados.tipo_usuario}</p>
                    `;
                }
            } catch (error) {
                document.getElementById('paciente-info').innerHTML = `
                    <p>${error.message}</p>
                `;
            }
        }

        // Função para alternar entre modo de edição e exibição normal
        function toggleEdit() {
            isEditing = !isEditing;
            obterInformacoesPaciente(usuarioId); 
        }

        // Função para salvar as alterações feitas
        async function salvarAlteracoes(id) {
            const nome = document.getElementById('edit-nome').value;
            const email = document.getElementById('edit-email').value;
            const ddd = document.getElementById('edit-ddd').value;
            const telefone = document.getElementById('edit-telefone').value;

            // Formatar o telefone no formato esperado (+DDD) 9XXXX-XXXX
            const telefoneCompleto = `+${ddd} ${telefone.replace(/\D/g, '').substring(0, 10)}`;

            try {
                const response = await fetch(`/atualizar_paciente/${id}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        nome: nome,
                        email: email,
                        telefone: telefoneCompleto 
                    })
                });

                if (response.ok) {
                    alert('Informações atualizadas com sucesso!');
                    // Redireciona para a mesma página do paciente com o novo nome e ID
                    window.location.href = `/paciente_dashboard?nome=${encodeURIComponent(nome)}&id=${encodeURIComponent(id)}`;
                } else {
                    alert('Erro ao salvar as alterações. Tente novamente.');
                }
            } catch (error) {
                alert('Erro ao salvar as alterações. Tente novamente.');
                console.error(error);
            }
        }

        async function excluirConta() {
            if (confirm("Você tem certeza que deseja excluir sua conta? Esta ação não pode ser desfeita.")) {
                try {
                    const response = await fetch('/excluir_conta', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        window.location.href = '/login'; // Redireciona para a página de login após a exclusão
                    } else {
                        alert('Ocorreu um erro ao tentar excluir sua conta. Tente novamente.');
                    }
                } catch (error) {
                    console.error('Erro ao excluir conta:', error);
                    alert('Ocorreu um erro ao tentar excluir sua conta. Tente novamente.');
                }
            }
        }

        function limpar_dados() {
            const divPacienteInfo = document.getElementById('paciente-info');
            divPacienteInfo.textContent = ''; // Limpa o conteúdo da div
        }

        document.addEventListener('DOMContentLoaded', function() {
            const botao = document.getElementById('get_usuario_info');
            const botaoLimpar = document.getElementById('limpar_dados');
            const botaoExcluir = document.getElementById('excluir_conta');
            const botaoEditar = document.getElementById('editar_info');

            // Adiciona evento para o botão "Excluir Conta"
            if (botaoExcluir) {
                botaoExcluir.addEventListener('click', excluirConta);
            }

            // Verifica se o botão de limpar dados existe antes de adicionar o evento
            if (botaoLimpar) {
                botaoLimpar.addEventListener('click', function() {
                    limpar_dados();
                });
            }

            // Adiciona evento para o botão "Editar Informações"
            if (botaoEditar) {
                botaoEditar.addEventListener('click', toggleEdit);
            }
        });
    </script>
</head>
<body>
    <div class="page">
        <header>
            <h1>Bem-vindo, {{ usuario_nome }}</h1>
            <nav>
                <a href="/agendar_consulta">Agendar Consulta</a>
                <a href="/minhas_consultas">Minhas Consultas</a>
                <a class="sair" id="excluir_conta" href="#">Excluir Conta</a>
                <a class="sair" href="/logout">Sair</a>
            </nav>
        </header>
        
        <main>
            <section class="formLogin">
                <h2>Informações do Paciente</h2>
                <div class="button-container">
                    <button class="btn" id="get_usuario_info" onclick="obterInformacoesPaciente('{{ usuario_id }}')">Dados do Usuário</button>
                    <button class="btn" id="editar_info">Editar Informações</button>
                    <button class="btn" id="limpar_dados">Limpar Dados</button>
                </div>
                <div id="paciente-info">
                    <!-- Informações do paciente serão exibidas aqui -->
                </div>
            </section>
        </main>
    </div>
</body>
</html>